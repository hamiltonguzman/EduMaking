<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="css/maincss.css">
        <link rel="stylesheet" href="css/bootstrap.min.css">
        <script type="text/javascript" src="js/bootstrap.min.js"></script>
        <script type="text/javascript" src="js/jquery-3.6.0.min.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
        <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
        <link rel="icon" href="Imagen/Logo.png">
        <title>EduMaking-CRM - Inscripción</title>
    </head>
    <body>
        <div class="cuerpoCompleto" display= "flex" justify-content= "center">
            <header>
                <div class="cabeza">
                    <img src="Imagen/logoEslogan1.png" >
                </div>
            </header>
            <div id="menuPpal">
                <menu-Ppal name-File = "Inscripcion.html"></menu-Ppal>
            </div>
            <div class="contenido" id="contenido-Inscr">
                <div class="form">
                    
                <div class="tab-content">
                    <div class="col-md">
                        <br/>
                    </div>
                    <div class="card" id="card-tblInscripciones">
                        <div class="boton">
                        <!--button type="submit" class="btn btn-primary">Crear Inscripción</button-->
                        <a class="btn btn-info" href="inscripcion-crear.html" role="button">Crear Inscripción</a>
                        </div>
                        <h3> </h3>
                        <h5 class="card-header rounded-top d-flex justify-content-center">Listado de Inscripciones</h5>
                        <div class="card-body">
                        <table class="table table-primary table-striped table-hover" name="tblInscripciones">
                            <thead>
                                <tr>
                                    <th scope="col" id="col1">#</th>
                                    <th scope="col" id="col2">Id. Curso</th>
                                    <th scope="col" id="col3">Curso</th>
                                    <th scope="col" id="col4">Instructor</th>
                                    <th scope="col" id="col5">Id. Estud.</th>
                                    <th scope="col" id="col6">Nombre Estudiante</th>
                                    <th scope="col" id="col7">Fecha Inicio</th>
                                    <th scope="col" id="col8">Fecha Fin</th>
                                    <th scope="col" id="col9">Certificado</th>
                                    <th scope="col" colspan="2" id="col10">Opciones</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                            <tfoot class="table-primary">
                            </tfoot>
                        </table>
                        </div> <!-- /card-body-->
                    </div> <!-- /card-->
                </div><!-- tab-content -->
            </div> <!-- /form -->
            </div> <!-- /contenido -->
            <footer>
                <div id="footer_wrapper">
                    <div id="footer">
                        Copyright © 2021 <a href="#">EduMaking</a> - Design: <a href="#">Grupo 7</a>
                    </div> <!-- end of footer -->
            </div> 
            </footer>
            <!-------------------------------------------------------------------------------------------->
            <div id="modalInscripcion" class="modal fade" tabindex="-1" aria-labelledby="ModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="ModalLabel">Modificación de Inscripción</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form action="http://localhost:8080/api/inscripciones" method="POST"  id="frmModal">
                                <div class="row">
                                    <div class="col-12 col-sm-6 mb-3">
                                        <label for="nombrecurso">Nombre del Curso<span class="req">*</span></label>
                                        <select name="nombrecurso" id="nombrecurso" required class="form-select" tabindex="1" autofocus onchange="runScriptInstr(event)">
                                            <option value="">Seleccione...</option>
                                        </select>
                                    </div>
                                    <div class="col-12 col-sm-6 mb-3">
                                        <label for="nombreinstructor">Nombre del Instructor</label>
                                        <input type="text" id="nombreinstructor" name="nombreinstructor" class="form-control" disabled>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-12 col-sm-4 mb-3">
                                        <label for="idestudiante">Id. del Estudiante<span class="req">*</span></label>
                                        <input type="text" id="idestudiante" name="idestudiante" required class="form-control"  onchange="runScriptEstud(event)" tabindex="3">
                                    </div>
                                    <div class="col-12 col-sm-8 mb-3">
                                        <label for="nomestudiante">Nombre</label>
                                        <input type="text" id="nomestudiante" name="nomestudiante" class="form-control" disabled>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-12 col-sm-4 mb-3">
                                        <label for="finicio">Fecha Inicio<span class="req">*</span></label>
                                        <input type="date" id="finicio" name="finicio" min="2000-01-01" max="2050-12-31" class="form-control" required>
                                    </div>

                                    <div class="col-12 col-sm-4 mb-3">
                                        <label for="ffin">Fecha Fin<span class="req">*</span></label>
                                        <input type="date" id="ffin" name="ffin" min="2000-01-01" max="2050-12-31" class="form-control" required>
                                    </div>

                                    <div class="col-12 col-sm-4 mb-3">
                                        <label for="estadocertif">Certificado<span class="req">*</span></label>
                                        <select class="form-select" name="estadocertif" id="estadocertif" required>
                                            <option value="">Seleccione...</option>
                                            <option value="ENTREGADO">Entregado</option>
                                            <option value="NO ENTREGADO">No Entregado</option>
                                        </select>
                                    </div>
                                    <input type="hidden" id="idInscr">
                                </div> 
                                
                                <div class="modal-footer">
                                    <button type="submit" class="btn btn-primary">Actualizar</button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!--------------------------------------------------------------------------------------------->
        <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
        <script src="js/app.js"></script>
        <script src = "js/crudInscr.js" type = "module"></script>
        
        <script>
            /* Obtengo el nombre del instructor */
            function runScriptInstr(e) {
                //let objSelCurso = document.getElementById('nombrecurso');
                let idCurso = document.getElementById('nombrecurso').value;
                let idInstr = '';
                
                // Con el id del curso, busco el dato del id del intructor
                const API_URL_CURSO = '//localhost:8080/api/cursos/' + idCurso

                fetch(`${API_URL_CURSO}`)
                    .then(response => response.json())
                    .then(data => document.getElementById('nombreinstructor').value = data.instructor.nombre)
                    .catch(error => console.log(error))
            }

            /* Obtengo el nombre del Estudiante */
            function runScriptEstud(e) {
                let ObjEstud = document.getElementById('idestudiante');
                let IdEstud = ObjEstud.value;
                const URL_ID_ESTUD = '//localhost:8080/api/personas/' + IdEstud;

                fetch(`${URL_ID_ESTUD}`)
                    .then(response => response.json())
                    .then(data => document.getElementById('nomestudiante').value = data.nombrePersona)
                    .catch(error => console.log(error))
            }

            /*function resetForm() {
                const FORM_MODAL = document.getElementById("frmModal");
                FORM_MODAL.reset();
            }*/

        
            /* Actualizamos los datos de inscrip. del formulario modal */
            const FORM_MODAL = document.getElementById("frmModal");
            FORM_MODAL.addEventListener('submit', (e)=>{
                e.preventDefault()
                const MODAL_INSCR = new bootstrap.Modal(document.getElementById('modalInscripcion'))
                let idInscr = document.getElementById('idInscr').value;
                const API_URL_INSCR = '//localhost:8080/api/inscripciones/actualizar/' + idInscr;
                let modalFormData = new FormData(FORM_MODAL);

                const objUpd = {
                    "curso": {
                        "id": modalFormData.get("nombrecurso")
                    },
                    "persona": {
                        "idPersona": modalFormData.get("idestudiante")
                    },
                    "fechaIni": modalFormData.get("finicio"),
                    "fechaFin": modalFormData.get("ffin"),
                    "certificado": modalFormData.get("estadocertif")
                };

                fetch(`${API_URL_INSCR}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type':'application/json'
                    },
                    body: JSON.stringify(objUpd)
                })
                .then((res) => {
                    res.json();
                    swal({
                        title: "INFORMACIÓN",
                        text: "La inscripción se actualizó exitosamente.",
                        type: "success"
                    }).then(function() {
                        MODAL_INSCR.hide();
                        location.reload();
                    });
                    
                })
                .catch((error) => console.error("Error:", error));
            })

        </script>
    </body>
</html>